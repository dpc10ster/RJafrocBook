---
output:
  pdf_document: default
  html_document: default
---
# Illustrations of the OR method {#ORExamples}

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(kableExtra)
library(ggplot2)
library(RJafroc)
library(here)
```

## Introduction {#ORExamples-introduction}
* Two examples are given. In the first example we use the VanDyke dataset, i.e., `dataset02`. 
* The analysis involves the following steps: calculate the figure of merit, calculate the variance-covariance matrix and the mean-squares, and calculate the NH statistic, p-value and confidence interval(s).

### Figures of merit
```{r}
foms <- UtilFigureOfMerit(dataset02, FOM = "Wilcoxon")
print(foms)
```

### Variance covariance and mean-squares
```{r}
ret <- UtilORVarComponentsFactorial(dataset02, FOM = "Wilcoxon", covEstMethod = "jackknife")
print(ret)
```

## Random-Reader Random-Case (RRRC) analysis
Illustrated next are the results of random-reader random-case analysis.

### Calculate F-statistic
The F-statistic is calculated using \@ref(eq:F-ORH-RRRC). The function `UtilORVarComponentsFactorial()` returns `ret`, which contains the values needed in this equation, as follows:

* MS(T) is in `ret$TRanova["T", "MS"]`, whose value is `r ret$TRanova["T", "MS"]`. 
* MS(TR) is in `ret$TRanova["TR", "MS"]`, whose value is `r ret$TRanova["TR", "MS"]`. 
* `J`, the number of readers, is the length of the second dimension of `dataset02$ratings$NL`, i.e., 5. 
* `Cov2` is in `ret$VarCom["Cov2", "Estimates"]`, whose value is `r ret$VarCom["Cov2", "Estimates"]`. 
* `Cov3` is in `ret$VarCom["Cov3", "Estimates"]`, whose value is `r ret$VarCom["Cov3", "Estimates"]`. 

Applying Eqn. \@ref(eq:F-ORH-RRRC) one gets (`den` is the denominator on the right hand side of this equation):

```{r}
J <- length(dataset02$ratings$NL[1,,1,1])
den <- ret$TRanova["TR", "MS"] + J* max(ret$VarCom["Cov2", "Estimates"] - ret$VarCom["Cov3", "Estimates"],0)
F_ORH_RRRC <- ret$TRanova["T", "MS"]/den
print(F_ORH_RRRC)
```

### Calculate ddf_H
From the previous chapter, the Hillis `ddf` is calculated using Eqn. \@ref(eq:ddfH-RRRC)). The numerator of `ddf` is seen to be identical to `den^2`, where `den` was calculated in the preceding code block. The implementation follows:

```{r}
I <- length(dataset02$ratings$NL[,1,1,1])
ddf <- den^2*(I-1)*(J-1)/(ret$TRanova["TR", "MS"])^2
print(ddf)
```

### Calculate the p-value
The relevant equation is Eqn. \@ref(eq:pValueOR-RRRC) whose implementation is shown next: 

```{r}
p <- 1 - pf(F_ORH_RRRC, I - 1, ddf)
print(p)
```

The difference is not significant at $\alpha$ = 0.05.

### Confidence intervals for reader-averaged inter-treatment FOM differences
Since `I` = 2, their is only one paired difference in reader-averaged FOMs, namely, the first treatment minus the second:

```{r}
trtMeans <- rowMeans(foms)
trtMeanDiffs <- trtMeans[1] - trtMeans[2]
print(trtMeanDiffs)
```

From the previous chapter, the $(1-\alpha)$ confidence interval for $\theta_{1 \bullet} - \theta_{2 \bullet}$ is given by Eqn. \@ref(eq:CI-RRRC). The expression inside the square-root symbol is `2/J*den`. The implementation follows:

```{r}
alpha <- 0.05
stdErr <- sqrt(2 * den/J)
t_crit <- abs(qt(alpha/2, ddf))
CI_RRRC <- c(trtMeanDiffs - t_crit*stdErr, trtMeanDiffs + t_crit*stdErr)
names(CI_RRRC) <- c("Lower", "Right")
print(CI_RRRC)
```

The confidence interval, shown as `[Lower, Right]`, includes zero, which confirms that the reader-averaged FOM difference between treatments is not significant. 

## Comparison to RJafroc
* This is accomplished using the significance testing function of `RJafroc`, namely `StSignificanceTesting()`. 
* This function takes as arguments the `dataset`, the `FOM`, set to "Wilcoxon", the method of analysis, set to "OR" and `analysisOption`, set to "RRRC". The significance level of the test, also an argument, `alpha`, defaults to 0.05. 
* The code below applies this function and saves the returned object to `st`. 
* The first member of this object, a  `list` object named `FOMs`, is then displayed. 
* `FOMs` contains three data frames: 
   + `FOMS$foms`, the figures of merit for each treatment and reader, 
   + `FOMS$trtMeans`, the figures of merit for each treatment averaged over readers, and 
   + `FOMS$trtMeanDiffs`, the inter-treatment difference figures of merit averaged over readers. The difference is always the first treatment minus the second, etc., in this example, `trt0` minus `trt1`.

```{r}
st <- StSignificanceTesting(dataset02, FOM = "Wilcoxon", method = "OR", analysisOption = "RRRC")
print(st$FOMs)
```

* Displayed next are the variance components and mean-squares. 
* These are contained in the `ANOVA` `list` object. 
* `ANOVA$TRanova` contains the treatment-reader ANOVA table, i.e. the sum of squares, the degrees of freedom and the mean-squares, listed for the treatment, reader and treatment-reader factors, i.e., `T`, `R` and `TR`.
* `ANOVA$VarCom` contains the OR variance components and the correlations.
* `ANOVA$IndividualTrt` contains the quantities necessary for individual treatment analyses.
* `ANOVA$IndividualRdr` contains the quantities necessary for individual reader analyses.

```{r}
print(st$ANOVA)
```

* Displayed next are the results of RRRC analysis.
* These are contained in the `RRRC` `list` object.
* `RRRC$FTests` contains the results of the F-tests.
* `RRRC$ciDiffTrt` contains the results of the confidence intervals for the inter-treatment difference FOMs, averaged over readers.
* `RRRC$ciAvgRdrEachTrt` contains the results of the confidence intervals for the treatments, averaged over readers.

```{r}
print(st$RRRC)
```


## Discussion/Summary/5


## References {#ORExamples-references}

