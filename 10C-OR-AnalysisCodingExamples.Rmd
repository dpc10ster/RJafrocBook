---
output:
  pdf_document: default
  html_document: default
---
# Illustrations using the Obuchowski Rockette method {#ORExamples} 

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(kableExtra)
library(ggplot2)
library(RJafroc)
library(here)
```

## Introduction {#ORExamples-introduction}
* Four examples are given. The first is a hand-calculation (i.e., from first principles, using the relevant formulae in the previous chapter). The next three examples use OR analysis as implemented in the `RJafroc` package. 
* The first example uses a two-treatment five-reader **ROC** dataset, well-know in the literature [@RN1993], as it has been used to illustrate advances in ROC methodology. 
* The second example uses a five-treatment four-reader **ROC** dataset, showing the effect of multiple treatment pairings on the significance testing (the first dataset has only one treatment pairing). 
* The third example uses a five-treatment four-reader **FROC** dataset, showing the key difference involved in FROC analysis. 
* Each analysis involves the following steps: 
+ Calculate the figure of merit, 
+ Calculate the variance-covariance matrix and the mean-squares, and 
+ Calculate the NH statistic, p-value and confidence interval(s).
* Each analysis is illustrated with three generalizations, namely RRRC, FRRC and RRFC.

## Hand calculation using dataset02 {#ORExamples-dataset02-hand}
* `dataset02` has `r length(dataset02$ratings$NL[,1,1,1])` modalities and `r length(dataset02$ratings$NL[1,,1,1])` readers. 

```{r}
I <- length(dataset02$ratings$NL[,1,1,1])
J <- length(dataset02$ratings$NL[1,,1,1])
modalityID <- dataset02$descriptions$modalityID
readerID <- dataset02$descriptions$readerID
```

* The first step is to calculate the figures of merit. 
* The following code uses `UtilFigureOfMerit()` to this end. Note that `FOM` is explicitly specified as "Wilcoxon".

```{r}
foms <- UtilFigureOfMerit(dataset02, FOM = "Wilcoxon")
print(foms)
```

* For example, for the first treatment, `trt0`, the second reader, `rdr1`, figure of merit is `r foms["trt0", "rdr1"]`.
* The next step is to calculate the variance-covariance matrix and the mean-squares.
* The function `UtilORVarComponentsFactorial()` returns these quantities, which are saved to `vc`. The `Factorial` in the function name is due to the fact that this code applies to the factorial design. A different function is used for a split-plot design.
* Only the first two members of the returned object are displayed in full. The remaining members, `vc$IndividualTrt` and `vc$IndividualRdr`, are used in single-treatment and single-reader analyses.

```{r}
vc <- UtilORVarComponentsFactorial(
  dataset02, 
  FOM = "Wilcoxon", covEstMethod = "jackknife")
summary(vc)
print(vc$TRanova)
print(vc$VarCom)
```

### Random-Reader Random-Case (RRRC) analysis {#ORExamples-RRRC-dataset02-hand}
* The next step is the calculate the NH testing statistic. The relevant equation is Eqn. \@ref(eq:F-ORH-RRRC). `vc` contains the values needed in this equation, as follows:
+ MS(T) is contained in `vc$TRanova["T", "MS"]`, whose value is `r vc$TRanova["T", "MS"]`. 
+ MS(TR) is contained in `vc$TRanova["TR", "MS"]`, whose value is `r vc$TRanova["TR", "MS"]`. 
+ `Cov2` is contained in `vc$VarCom["Cov2", "Estimates"]`, whose value is `r vc$VarCom["Cov2", "Estimates"]`. 
+ `Cov3` is contained in `vc$VarCom["Cov3", "Estimates"]`, whose value is `r vc$VarCom["Cov3", "Estimates"]`. 

[`Cov1`, contained in `vc$VarCom["Cov2", "Estimates"]` is not needed in the current calculation.]

Applying Eqn. \@ref(eq:F-ORH-RRRC) one gets (`den` is the denominator on the right hand side of the referenced equation):

```{r}
den <- vc$TRanova["TR", "MS"] + 
  J* max(vc$VarCom["Cov2", "Estimates"] - 
           vc$VarCom["Cov3", "Estimates"],0)
F_ORH_RRRC <- vc$TRanova["T", "MS"]/den
print(F_ORH_RRRC)
```

* The numerator degrees of freedom is $I-1$.
* The denominator degrees of freedom, `ddf`, is calculated using Eqn. \@ref(eq:ddfH-RRRC)). 
* The numerator of `ddf` is seen to be identical to `den^2`, where `den` was calculated in the preceding code block. The implementation follows:

```{r}
ddf <- den^2*(I-1)*(J-1)/(vc$TRanova["TR", "MS"])^2
```

* The value of `ddf` is `r ddf`.
* The next step is calculation of the p-value for rejecting the NH.
* The relevant equation is Eqn. \@ref(eq:pValueOR-RRRC) whose implementation follows: 

```{r}
p_RRRC <- 1 - pf(F_ORH_RRRC, I - 1, ddf)
```

* The p-value is `r p_RRRC`. The difference is not significant at $\alpha$ = 0.05. 
* The next step is calculation of the confidence interval for paired FOM differences. Since `I` = 2, their is only one paired difference in reader-averaged FOMs, namely, the first treatment minus the second:

```{r}
trtMeans <- rowMeans(foms)
trtMeanDiffs <- trtMeans[1] - trtMeans[2]
```

* The difference in reader-averaged FOM,s i.e., $\theta_{1 \bullet} - \theta_{2 \bullet}$, is `r trtMeanDiffs`.
* The $(1-\alpha)$ confidence interval the difference is given by Eqn. \@ref(eq:CI-diffFomRRRC).
* The expression inside the square-root symbol in this equation is `2/J*den`. 
* The implementation follows:

```{r}
alpha <- 0.05
stdErr <- sqrt(2 * den/J)
tStat <- vector()
PrGTt <- vector()
CI_RRRC <- array(dim = c(length(trtMeanDiffs), 2))
for (i in 1:length(trtMeanDiffs)) {
  tStat[i] <- trtMeanDiffs[i]/stdErr
  PrGTt[i] <- 2*pt(abs(tStat[i]), ddf, lower.tail = FALSE)
  CI_RRRC[i, ] <- sort(c(trtMeanDiffs[i] - qt(alpha/2, ddf) * stdErr, trtMeanDiffs[i] + qt(alpha/2, ddf) * stdErr))
}
print(CI_RRRC)
```

The confidence interval includes zero, which confirms that the reader-averaged FOM difference between treatments is not significant. 

### Fixed-Reader Random-Case (FRRC) analysis {#ORExamples-FRRC-dataset02-hand}
* The F-statistic for testing the NH of no treatment effect was stated in \@ref(eq:DefFStatFRRC-OR). 
* The quantities needed to evaluate the right hand side are:
+ `MS(T)`, which is contained in vc$TRanova["T", "MS"];
+ `Var`, which is contained in vc$VarCom["Var", "Estimates"];
+ `Cov1`, which is contained in vc$VarCom["Cov1", "Estimates"];
+ `Cov2`, which is contained in vc$VarCom["Cov2", "Estimates"];
+ `Cov3`, which is contained in vc$VarCom["Cov3", "Estimates"].
* The implementation follows:

```{r}
den <- vc$VarCom["Var", "Estimates"] - 
  vc$VarCom["Cov1", "Estimates"] + 
  (J-1) * max(vc$VarCom["Cov2", "Estimates"]-vc$VarCom["Cov3", "Estimates"],0)
F_ORH_FRRC <- vc$TRanova["T", "MS"]/den
print(F_ORH_FRRC)
```

* `F_ORH_FRRC` is distributed as an F-statistic with `ndf` = I-1 and `ddf` = infinity. 
* `F_ORH_FRRC` times (I-1) is distributed as a chi-square-statistic with $I-1$ degrees of freedom.
*  The observed value of the chi-square statistic is `r F_ORH_FRRC * (I-1)`.
*  The p-value is calculated using \@ref(eq:pValueFRRC-OR), whose implementation follows:

```{r}
p_FRRC <- 1 - pchisq(F_ORH_FRRC * (I - 1), I - 1)
```

* The p-value is `r p_FRRC`, which is significant at $\alpha$ = 0.05.
* The confidence interval for the difference FOM is in Eqn. \@ref(eq:CIDiffFomFRRC-OR). Its implementation follows: 

```{r}
stdErr <- sqrt(2/J * (vc$VarCom["Var", "Estimates"] - 
                        vc$VarCom["Cov1", "Estimates"] + 
                        (J-1)*max(vc$VarCom["Cov2", "Estimates"]-vc$VarCom["Cov3", "Estimates"],0)))
zStat <- vector()
PrGTz <- vector()
CI_FRRC <- array(dim = c(choose(I,2),2))
for (i in 1:choose(I,2)) {
  zStat[i] <- trtMeanDiffs[i]/stdErr
  PrGTz[i] <- 2 * pnorm(abs(zStat[i]), lower.tail = FALSE)
  CI_FRRC[i, ] <- c(trtMeanDiffs[i] + qnorm(alpha/2) * stdErr, 
                    trtMeanDiffs[i] + qnorm(1-alpha/2) * stdErr)
}
print(CI_FRRC)
```

Note that this time, consistent with the p-value finding, the confidence interval does not include zero.

One can calculate confidence intervals for each treatment, using data from that treatment only, Eqn.  \@ref(eq:CIIndTrtFomFRRC-OR). The required `Var_i` and `Cov2_i`, calculated over each treatment, are in `vc$IndividualTrt`. The implementation follows.

```{r}
CI <- array(dim = c(I,2))
ci <- data.frame()
for (i in 1:I) {
  stdErr <- sqrt(1/J * (vc$IndividualTrt[i, "varEachTrt"] + 
                          (J-1)*max(vc$IndividualTrt[i, "cov2EachTrt"],0)))
  t_crit <- abs(qt(alpha/2, Inf))
  CI[i,] <- c(trtMeans[i] - t_crit*stdErr, trtMeans[i] + t_crit*stdErr)
  rowName <- paste0("trt", modalityID[i])
  ci <- rbind(ci, data.frame(Estimate = trtMeans[i], 
                             CILower = CI[i,1],
                             CIUpper = CI[i,2],
                             row.names = rowName,
                             stringsAsFactors = FALSE))
}
print(ci)
```

One can calculate confidence intervals for inter-treatment FOM differences for individual readers. Each analysis is based only on data for the specified reader, i.e, on the reader-specific `AUC`, variance and `Cov1` estimates. The required `Var_j` and `Cov1_j` are in `vc$IndividualRdr`. The implementation follows.

```{r}
diffTRName <- array(dim = choose(I, 2))
ii <- 1
for (i in 1:I) {
  if (i == I) 
    break
  for (ip in (i + 1):I) {
    diffTRName[ii] <- paste0("trt", modalityID[i], sep = "-", "trt", modalityID[ip]) # !sic
    ii <- ii + 1
  }
}

trtMeanDiffs <- array(dim = c(J, choose(I, 2)))
Reader <- array(dim = c(J, choose(I, 2)))
stdErr <- array(dim = c(J, choose(I, 2)))
zStat <- array(dim = c(J, choose(I, 2)))
trDiffNames <- array(dim = c(J, choose(I, 2)))
PrGTz <- array(dim = c(J, choose(I, 2)))
CIReader <- array(dim = c(J, choose(I, 2),2))
ci <- data.frame()
for (j in 1:J) {
  Reader[j,] <- rep(readerID[j], choose(I, 2))
  stdErr[j,] <- sqrt(2 * (vc$IndividualRdr[j,"varEachRdr"] - vc$IndividualRdr[j,"cov1EachRdr"]))
  pair <- 1
  for (i in 1:I) {
    if (i == I) break
    for (ip in (i + 1):I) {
      trtMeanDiffs[j, pair] <- foms[i, j] - foms[ip, j]
      trDiffNames[j,pair] <- diffTRName[pair]
      zStat[j,pair] <- trtMeanDiffs[j,pair]/stdErr[j,pair]
      PrGTz[j,pair] <- 2 * pnorm(abs(zStat[j,pair]), lower.tail = FALSE)
      CIReader[j, pair,] <- c(trtMeanDiffs[j,pair] + qnorm(alpha/2) * stdErr[j,pair], 
                              trtMeanDiffs[j,pair] + qnorm(1-alpha/2) * stdErr[j,pair])
      rowName <- paste0("rdr", Reader[j,pair], "::", trDiffNames[j, pair])
      ci <- rbind(ci, data.frame(Estimate = trtMeanDiffs[j, pair], 
                                 StdErr = stdErr[j,pair], 
                                 z = zStat[j, pair], 
                                 PrGTz = PrGTz[j, pair], 
                                 CILower = CIReader[j, pair,1],
                                 CIUpper = CIReader[j, pair,2],
                                 row.names = rowName,
                                 stringsAsFactors = FALSE))
      pair <- pair + 1
    }
  }
}
print(ci)
```

### Random-Reader Fixed-Case (RRFC) analysis {#ORExamples-RRFC-dataset02-hand}
TBA

## Using RJafroc: dataset02 {#ORExamples-dataset02-RJafroc}
### Random-Reader Random-Case (RRRC) analysis {#ORExamples-RRRC-dataset02-RJafroc}
* This is accomplished using the significance testing function `StSignificanceTesting()`. 
* Since `analysisOption` is not explicitly specified in the following code, the function `StSignificanceTesting` performs all three analyses: `RRRC`, `FRRC` and `RRFC`.
* The significance level of the test, also an argument, `alpha`, defaults to 0.05. 
* The code below applies this function and saves the returned object to `st1`. 
* The first member of this object, a  `list` object named `FOMs`, is then displayed. 
* `FOMs` contains three data frames: 
+ `FOMS$foms`, the figures of merit for each treatment and reader, 
+ `FOMS$trtMeans`, the figures of merit for each treatment averaged over readers, and 
+ `FOMS$trtMeanDiffs`, the inter-treatment difference figures of merit averaged over readers. The difference is always the first treatment minus the second, etc., in this example, `trt0` minus `trt1`.

```{r}
st1 <- StSignificanceTesting(dataset02, FOM = "Wilcoxon", method = "OR")
print(st1$FOMs)
```

* Displayed next are the variance components and mean-squares. 
* These are contained in the `ANOVA` `list` object. 
* `ANOVA$TRanova` contains the treatment-reader ANOVA table, i.e. the sum of squares, the degrees of freedom and the mean-squares, listed for the treatment, reader and treatment-reader factors, i.e., `T`, `R` and `TR`.
* `ANOVA$VarCom` contains the OR variance components and the correlations.
* `ANOVA$IndividualTrt` contains the quantities necessary for individual treatment analyses.
* `ANOVA$IndividualRdr` contains the quantities necessary for individual reader analyses.

```{r}
print(st1$ANOVA)
```

* Displayed next are the results of RRRC analysis, contained in the `RRRC` `list` object.
* `RRRC$FTests` contains the results of the F-tests.
* `RRRC$ciDiffTrt` contains the results of the confidence intervals for the inter-treatment difference FOMs, averaged over readers.
* `RRRC$ciAvgRdrEachTrt` contains the results of the confidence intervals for the treatments, averaged over readers.

```{r}
print(st1$RRRC$FTests)
```

* TBA

```{r}
print(st1$RRRC$ciDiffTrt[,-c(2:5)])
```

* TBA

```{r}
print(st1$RRRC$ciAvgRdrEachTrt[,-c(2,3,6)])
```

* TBA

### Fixed-Reader Random-Case (FRRC) analysis {#ORExamples-FRRC-dataset02-RJafroc}

* TBA

```{r}
print(st1$FRRC$FTests)
```

* TBA

```{r}
print(st1$FRRC$ciDiffTrt[,-c(2:4)])
```

* TBA

```{r}
print(st1$FRRC$ciAvgRdrEachTrt[,-c(2,3,5)])
```

### Random-Reader Fixed-Case (RRFC) analysis {#ORExamples-RRFC-dataset02-RJafroc}

```{r}
print(st1$RRFC$FTests)
```

* TBA

```{r}
print(st1$RRFC$ciDiffTrt[,-c(2,3,4,5)])
```

## Using RJafroc: dataset04 {#ORExamples-dataset04-RJafroc}
* The second example uses the Federica Zanca dataset [@RN1882], i.e., `dataset04`, which has five modalities and four readers. 
* This illustrates the situation when multiple treatment pairings are involved. In contrast, the previous example had only one treatment pairing.
* Since this is an FROC dataset, in order to keep this comparable with the previous example, one converts it to an inferred-ROC dataset.
* The function `DfFroc2Roc(dataset04)` converts, using the highest-rating, the FROC dataset to an inferred-ROC dataset.
* The results are contained in the returned `list` object `st2`.

```{r}
ds <- DfFroc2Roc(dataset04) # convert to ROC
I <- length(ds$ratings$NL[,1,1,1])
J <- length(ds$ratings$NL[1,,1,1])
cat("I = ", I, ", J = ", J, "\n")
st2 <- StSignificanceTesting(ds, FOM = "Wilcoxon", method = "OR")
print(st2$FOMs)
print(st2$ANOVA$TRanova)
print(st2$ANOVA$VarCom)
```

### Random-Reader Random-Case (RRRC) analysis {#ORExamples-RRRC-dataset04}

```{r}
print(st2$RRRC$FTests)
```

* TBA

```{r}
print(st2$RRRC$ciDiffTrt[,-c(2:5)])
```

* TBA

```{r}
print(st2$RRRC$ciAvgRdrEachTrt[,-c(2,3,6)])
```

* TBA

### Fixed-Reader Random-Case (FRRC) analysis {#ORExamples-FRRC-dataset04}

```{r}
print(st2$FRRC$FTests)
```

* TBA

```{r}
print(st2$FRRC$ciDiffTrt[,-c(2:4)])
```

* TBA

```{r}
print(st2$FRRC$ciAvgRdrEachTrt[,-c(2,3,5)])
```

* TBA

```{r}
print(st2$FRRC$FTests)
```

* TBA

### Random-Reader Fixed-Case (RRFC) analysis {#ORExamples-RRFC-dataset04}

```{r}
print(st2$RRFC$FTests)
```

* TBA

```{r}
print(st2$RRFC$ciDiffTrt[,-c(2,3,4,5)])
```



## Using RJafroc: dataset04, FROC analysis {#ORExamples-dataset04-FROC-RJafroc}
* The third example uses `dataset04`, but this time we use the FROC data, i.e, we do not convert it to inferred-ROC. 
* Since this is an FROC dataset, one needs to use an FROC figure of merit. 
* In this example the weighted AFROC figure of merit `FOM = "wAFROC"` is specified. This is the recommended figure of merit when both normal and abnormal cases are present in the dataset.
* If the dataset does not contain normal cases, then the weighted AFROC1 figure of merit `FOM = "wAFROC1"` should be specified. 

```{r}
ds1 <- dataset04 # do NOT convert to ROC
# comment/uncomment following code to disable/enable unequal weights
# K2 <- length(ds1$ratings$LL[1,1,,1])
# weights <- array(dim = c(K2, max(ds1$lesions$perCase)))
# perCase <- ds1$lesions$perCase
# for (k2 in 1:K2) {
#   sum <- 0
#   for (el in 1:perCase[k2]) {
#     weights[k2,el] <- 1/el
#     sum <- sum + 1/el
#   }
#   weights[k2,1:perCase[k2]] <- weights[k2,1:perCase[k2]] / sum
# }
# ds1$lesions$weights <- weights
ds <- ds1
FOM <- "wAFROC" # also try wAFROC1, MaxLLF and MaxNLF
st3 <- StSignificanceTesting(ds, FOM = FOM, method = "OR")
print(st3$FOMs)
print(st3$ANOVA$TRanova)
print(st3$ANOVA$VarCom)
```

### Random-Reader Random-Case (RRRC) analysis {#ORExamples-RRRC-dataset04-FROC}

```{r}
print(st3$RRRC$FTests)
```

* TBA

```{r}
print(st3$RRRC$ciDiffTrt[,-c(2:5)])
```

* TBA

```{r}
print(st3$RRRC$ciAvgRdrEachTrt[,-c(2,3,6)])
```

* TBA

### Fixed-Reader Random-Case (FRRC) analysis {#ORExamples-FRRC-dataset04-FROC}

```{r}
print(st3$FRRC$FTests)
```

* TBA

```{r}
print(st3$FRRC$ciDiffTrt[,-c(2:4)])
```

* TBA

```{r}
print(st3$FRRC$ciAvgRdrEachTrt[,-c(2,3,5)])
```

* TBA

```{r}
print(st3$FRRC$FTests)
```

* TBA

### Random-Reader Fixed-Case (RRFC) analysis {#ORExamples-RRFC-dataset04-FROC}

```{r}
print(st3$RRFC$FTests)
```

* TBA

```{r}
print(st3$RRFC$ciDiffTrt[,-c(2,3,4,5)])
```


## Discussion/Summary/5

## References {#ORExamples-references}

