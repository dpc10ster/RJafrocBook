# FROC vs. wAFROC {#froc-vs-afroc}

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(RJafroc)
library(ggplot2)
library(kableExtra)
library(gridExtra)
library(abind)
library(here)
```

## Introduction {#froc-vs-wafroc-intro}

-   TBA This chapter needs a major rewrite; 10/6/20
-   One plot is being repeated
-   Need to add comparisons to ROC
-   Don't need columns 1 and 3 in table

The FROC curve was introduced in [@bunch1977free] and ever since it has been widely used for evaluating performance in the free-response paradigm, particularly in 1 algorithm development. Typically 1 researchers report "sensitivity was observed to be xx at yy false positives per image." Occasionally, using less ambiguous terminology, they report an observed operating point on the FROC, as in "LLF was observed to be xx at NLF = yy". The lessons learned from ROC analysis, see Section \@ref(binary-task-beam-study), that a scalar FOM is preferable to sensitivity-specificity pairs, has apparently been forgotten.

This chapter recommends adoption of the wAFROC as the preferred operating characteristic in assessing performance in the free-response paradigm, and details simulation-based studies supporting this recommendation.

## FROC vs. wAFROC

Recall, from Section \@ref(froc-paradigm-preview-rsm), that the RSM is defined by parameters $\mu, \lambda, \nu$, and a threshold parameter $\zeta_1$ which determines if latent localizations are actually marked. This section examines RSM-predicted empirical FROC, wAFROC and ROC plots for two simulated observers denoted RAD-1 and RAD-2. The former could be an algorithmic observer while the latter could be a radiologist. For typical threshold $\zeta_1$ parameters, three types of simulations are considered: RAD-2 has moderately better performance than RAD-1, RAD-2 has much better performance than RAD-1 and RAD-2 has slightly better performance than RAD-1. For each type of simulation pairs of FROC, wAFROC and ROC curves are shown, one for each observer. Finally the simulations and plots are repeated for hypothetical RAD-1 and RAD-2 observers who report all suspicious regions, i.e., $\zeta_1 = -\infty$ for each observer. Both RAD-1 and RAD-2 observers share the same $\lambda, \nu$ parameters, and the only difference between them is in the $\mu$ and $\zeta_1$ parameters.   

### Moderate difference in performance

```{r doOneFigure, echo=FALSE}
do_one_figure <- function(
  seed, Lmax, muCad, 
  muRad, lambda, nu, zeta1Cad, zeta1Rad, K1, K2) {
  set.seed(seed)
  Lk2 <- floor(runif(K2, 1, Lmax + 1))
  
  retABC <- CadVsRadPlots (
    muCad, 
    muRad, 
    lambda, 
    nu, 
    zeta1Cad, 
    zeta1Rad, 
    K1, 
    K2, 
    Lk2, 
    seed)
  
  froc_plot_A <- retABC$froc$Plot + labs(tag = "A")
  wafroc_plot_B <- retABC$wafroc$Plot + labs(tag = "B")
  roc_plot_C <- retABC$roc$Plot + labs(tag = "C")
  wafroc_1_B <- retABC$wafroc1
  wafroc_2_B <- retABC$wafroc2
  roc_1_C <- retABC$roc1
  roc_2_C <- retABC$roc2
  
  zeta1Cad <- -Inf
  zeta1Rad <- -Inf
  
  retDEF <- CadVsRadPlots (
    muCad, 
    muRad, 
    lambda, 
    nu, 
    zeta1Cad, 
    zeta1Rad, 
    K1, 
    K2, 
    Lk2, 
    seed)
  
  froc_plot_D <- retDEF$froc$Plot + labs(tag = "D")
  wafroc_plot_E <- retDEF$wafroc$Plot + labs(tag = "E")
  roc_plot_F <- retDEF$roc$Plot + labs(tag = "F")
  wafroc_1_E <- retDEF$wafroc1
  wafroc_2_E <- retDEF$wafroc2
  roc_1_F <- retDEF$roc1
  roc_2_F <- retDEF$roc2
  
  return(list(
    froc_plot_A = froc_plot_A,
    wafroc_plot_B = wafroc_plot_B,
    roc_plot_C = roc_plot_C,
    froc_plot_D = froc_plot_D,
    wafroc_plot_E = wafroc_plot_E,
    roc_plot_F = roc_plot_F,
    wafroc_1_B = wafroc_1_B,
    wafroc_2_B = wafroc_2_B,
    roc_1_C = roc_1_C,
    roc_2_C = roc_2_C,
    wafroc_1_E = wafroc_1_E,
    wafroc_2_E = wafroc_2_E,
    roc_1_F = roc_1_F,
    roc_2_F = roc_2_F
  ))
}
```

```{r fig1, cache = FALSE, attr.source = ".numberLines"}
source(here("R/CH13-CadVsRadPlots/CadVsRadPlots.R"))

nu <- 1
lambda <- 1
K1 <- 500
K2 <- 700
muCad <- 1.0
muRad <- 1.5
zeta1Cad <- -1
zeta1Rad <- 1.5
Lmax <- 2
seed <- 1

ret <- do_one_figure (
  seed, Lmax, muCad, 
  muRad, lambda, nu, zeta1Cad, zeta1Rad, K1, K2)

froc_plot_1A <- ret$froc_plot_A
wafroc_plot_1B <- ret$wafroc_plot_B
roc_plot_1C <- ret$roc_plot_C
froc_plot_1D <- ret$froc_plot_D
wafroc_plot_1E <- ret$wafroc_plot_E
roc_plot_1F <- ret$roc_plot_F
wafroc_1_1B <- ret$wafroc_1_B
wafroc_2_1B <- ret$wafroc_2_B
roc_1_1C <- ret$roc_1_C
roc_2_1C <- ret$roc_2_C
wafroc_1_1E <- ret$wafroc_1_E
wafroc_2_1E <- ret$wafroc_2_E
roc_1_1F <- ret$roc_1_F
roc_2_1F <- ret$roc_2_F
```

The $\lambda$ and $\nu$ parameters are defined at lines 3 and 4 of the preceding code: $\lambda = \nu = 1$. The number of simulated cases is defined, lines 5-6, by $K_1 = 500$ and $K_2 = 700$. The simulated RAD-1 observer $\mu$ parameter is defined at line 7 by $\mu_{1} = 1$ and that of the simulated RAD-2 observer is defined at line 8 by $\mu_{2} = 1.5$. Based on these choices one expect RAD-2 to be moderately better than RAD-1. The corresponding threshold parameters are (lines 9 -10) $\zeta_{1} = -1$ for RAD-1 and $\zeta_{1} = 1.5$ for RAD-2. The maximum number of lesions per case is defined at line 11 by `Lmax` = 2. The actual number of lesions per case is determined determined by random sampling within the helper function `do_one_figure()` called at lines 14-16. This function returns a large list `ret`, whose contents are as follows:

* `ret$froc_plot_A`: a pair of FROC plots for the thresholds specified above, a red plot labeled "R: 1" corresponding to RAD-1 and a blue plot labeled "R: 2" corresponding to RAD-2. These are shown in panel A.
* `ret$wafroc_plot_B`: a pair of wAFROC plots, similarly labeled. These are shown in panel B.
* `ret$roc_plot_C`: a pair of ROC plots, similarly labeled. These are shown in panel C.
* `ret$froc_plot_D`: a pair of FROC plots for the both thresholds at $-\infty$. These are shown in panel D.
* `ret$froc_plot_E`: a pair of wAFROC plots for the both thresholds at $-\infty$. These are shown in panel E.
* `ret$froc_plot_F`: a pair of ROC plots for the both thresholds at $-\infty$. These are shown in panel F.
* `ret$wafroc_1_B`: the wAFROC AUC for RAD-1, i.e., the area under the curve labeled "R: 1" in panel B.
* `ret$wafroc_2_B`: the wAFROC AUC for RAD-2, i.e., the area under the curve labeled "R: 2" in panel B.
* `ret$roc_1_C`: the ROC AUC for RAD-1, i.e., the area under the curve labeled "R: 1" in panel C.
* `ret$roc_2_C`: the ROC AUC for RAD-2, i.e., the area under the curve labeled "R: 2" in panel C.
* `ret$wafroc_1_E`: the wAFROC AUC for RAD-1, i.e., the area under the curve labeled "R: 1" in panel E.
* `ret$wafroc_2_E`: the wAFROC AUC for RAD-2, i.e., the area under the curve labeled "R: 2" in panel E.
* `ret$roc_1_F`: the ROC AUC for RAD-1, i.e., the area under the curve labeled "R: 1" in panel F.
* `ret$roc_2_F`: the ROC AUC for RAD-2, i.e., the area under the curve labeled "R: 2" in panel F.

```{r froc-vs-afroc-plot1, fig.cap="Plots A and B are for 1 $\\zeta_1 = -1$ and 2 $\\zeta_1 = 1.5$ and plots C and D are plots for 1 $\\zeta_1 = -\\infty$ and 2 $\\zeta_1 = -\\infty$. Plots A and C: FROC curves for the 1 and 2 observers. B and D: corresponding wAFROC curves.", fig.show='hold', echo=FALSE}
grid.arrange(froc_plot_1A,wafroc_plot_1B,roc_plot_1C,froc_plot_1D,wafroc_plot_1E,roc_plot_1F,nrow=2,ncol=3)
```


```{r extractEndPts1, echo=FALSE}
# extract coordinates of end-point
# the 1 refers to fig. 1
nlf_1_1A <- max(froc_plot_1A$data$genAbscissa[froc_plot_1A$data$Reader == "R: 1"]) 
llf_1_1A <- max(froc_plot_1A$data$genOrdinate[froc_plot_1A$data$Reader == "R: 1"]) 
nlf_2_1A <- max(froc_plot_1A$data$genAbscissa[froc_plot_1A$data$Reader == "R: 2"]) 
llf_2_1A <- max(froc_plot_1A$data$genOrdinate[froc_plot_1A$data$Reader == "R: 2"]) 

nlf_1_1D <- max(froc_plot_1D$data$genAbscissa[froc_plot_1D$data$Reader == "R: 1"]) 
llf_1_1D <- max(froc_plot_1D$data$genOrdinate[froc_plot_1D$data$Reader == "R: 1"]) 
nlf_2_1D <- max(froc_plot_1D$data$genAbscissa[froc_plot_1D$data$Reader == "R: 2"]) 
llf_2_1D <- max(froc_plot_1D$data$genOrdinate[froc_plot_1D$data$Reader == "R: 2"]) 
```

The coordinates of the end-point of the RAD-1 FROC in plot A are (`r nlf_1_1A`, `r llf_1_1A`). Those of the RAD-2 FROC plot in A are (`r nlf_2_1A`, `r llf_2_1A`). The FROC for the RAD-1 observer extends to much larger NLF values while that for the RAD-2 observer is relatively short and steep. One suspects the RAD-2 observer is performing better than RAD-1: he is better at finding lesions and producing fewer NLs, both of which are desirable characteristics, but he is adopting a too-strict reporting criterion. If he could be induced to relax the threshold and report more NLs, his LLF would exceed that of the RAD-1 observer while still maintaining a lower NLF. However, as this involves a subjective extrapolation, it is not possible to objectively quantify this from the FROC curves. The basic issue is the lack of a common NLF range for the two plots. If a common NLF range is "forced", for example defined as the common NLF range 0 to `r max(froc_plot_1A$data$genAbscissa[froc_plot_1A$data$Reader == "R: 2"])`, where both curves contribute, it would ignore most NLs from the RAD-1 observer.

Algorithm developers typically quote LLF at a specified NLF. According to the two plots in A, the RAD-2 observer is better if the NLF value is chosen to less than `r max(froc_plot_1A$data$genAbscissa[froc_plot_1A$data$Reader == "R: 2"])` (this is the maximum NLF value for the RAD-2 plot in A) but there is no basis for comparison for larger values of NLF (because the RAD-2 observer does not provide any data beyond the observed end-point). A similar problem was encountered in ROC analysis when comparing a pair of sensitivity-specificity values, where, given differing choices of thresholds, ambiguous results can be obtained, see Section \@ref(binary-task-beam-study). Indeed, this was the rationale for using AUC under the ROC curve as an unambiguous measure of performance.

Plot B shows wAFROC curves for the same datasets whose FROC curves are shown in plot A. **The wAFROC is contained within the unit square, a highly desirable characteristic, which solves the lack of a common NLF range problem with the FROC.** The wAFROC AUC under the RAD-2 observer is visibly greater than that for the RAD-1 observer, even though -- due to his higher threshold -- his AUC estimate is actually biased downward (because the RAD-2 observer is adopting a high threshold, his $\text{LLF}_{\text{max}}$ is smaller than it would have been with a lower threshold, and consequently the area under the large straight line segment from the uppermost non-trivial operating point to (1,1) is smaller). AUCs under the two wAFROC plots in B are `r wafroc_1_1B` for RAD-1 and `r wafroc_2_1B` for RAD-2.


Plot C shows ROC curves. Since the curves cross, it is not clear which has the larger AUC. AUCs under the two curves in C are `r roc_1_1C` for RAD-1 and `r roc_2_1C` for RAD-2, which are close, but here is an example where the ordering given by the wAFROC is opposite to that given by the ROC. 

Plots D, E and F correspond to A, B and C with this important difference: the two threshold parameters are set to $-\infty$. The coordinates of the end-point of the RAD-1 FROC in panel D are (`r nlf_1_1D`, `r llf_1_1D`). Those of the RAD-2 FROC in panel D are (`r nlf_2_1D`, `r llf_2_1D`). The RAD-2 observer has higher LLF at lower NLF, and there can be no doubt that he is better. Panels E and F confirm that RAD-2 is actually the better observer *over the entire FPF range*. AUCs under the two wAFROC curves in E are `r wafroc_1_1E` for RAD-1 and `r wafroc_2_1E` for RAD-2. AUCs under the two ROC curves in F are `r roc_1_1F` for RAD-1 and `r roc_2_1F` for RAD-2. These confirm the visual impressions of plots in panels E and F. Notice that each ROC AUC is larger than the corresponding wAFROC AUC. This is because the probability of a lesion localization (case is declared positive *and* a lesion is correctly localized) is smaller than the probability of a true positive (case is declared positive). In other words, the ROC is everywhere above the wAFROC.


### Large difference in performance

```{r fig2, cache = FALSE, echo=FALSE}
source(here("R/CH13-CadVsRadPlots/CadVsRadPlots.R"))

nu <- 1
lambda <- 1
K1 <- 500
K2 <- 700
muCad <- 1
muRad <- 2
zeta1Cad <- -1
zeta1Rad <- 2
Lmax <- 2
seed <- 1

ret <- do_one_figure (
  seed, Lmax, muCad, 
  muRad, lambda, nu, zeta1Cad, zeta1Rad, K1, K2)

froc_plot_2A <- ret$froc_plot_A
wafroc_plot_2B <- ret$wafroc_plot_B
roc_plot_2C <- ret$roc_plot_C
froc_plot_2D <- ret$froc_plot_D
wafroc_plot_2E <- ret$wafroc_plot_E
roc_plot_2F <- ret$roc_plot_F
wafroc_1_2B <- ret$wafroc_1_B
wafroc_2_2B <- ret$wafroc_2_B
roc_1_2C <- ret$roc_1_C
roc_2_2C <- ret$roc_2_C
wafroc_1_2E <- ret$wafroc_1_E
wafroc_2_2E <- ret$wafroc_2_E
roc_1_2F <- ret$roc_1_F
roc_2_2F <- ret$roc_2_F
```


```{r extractEndPts2, echo=FALSE}
# extract coordinates of end-point
nlf_1_2A <- max(froc_plot_2A$data$genAbscissa[froc_plot_2A$data$Reader == "R: 1"]) 
llf_1_2A <- max(froc_plot_2A$data$genOrdinate[froc_plot_2A$data$Reader == "R: 1"]) 
nlf_2_2A <- max(froc_plot_2A$data$genAbscissa[froc_plot_2A$data$Reader == "R: 2"]) 
llf_2_2A <- max(froc_plot_2A$data$genOrdinate[froc_plot_2A$data$Reader == "R: 2"]) 

nlf_1_2D <- max(froc_plot_2D$data$genAbscissa[froc_plot_2D$data$Reader == "R: 1"]) 
llf_1_2D <- max(froc_plot_2D$data$genOrdinate[froc_plot_2D$data$Reader == "R: 1"]) 
nlf_2_2D <- max(froc_plot_2D$data$genAbscissa[froc_plot_2D$data$Reader == "R: 2"]) 
llf_2_2D <- max(froc_plot_2D$data$genOrdinate[froc_plot_2D$data$Reader == "R: 2"]) 

x <- wafroc_plot_2B$data$genAbscissa[wafroc_plot_2B$data$Reader == "R: 2"];fpfRad2B <- x[length(x)-1]
x <- wafroc_plot_2E$data$genAbscissa[wafroc_plot_2E$data$Reader == "R: 2"];fpfRad2E <- x[length(x)-1]
llf_2_2B <- max(froc_plot_2A$data$genOrdinate[froc_plot_2A$data$Reader == "R: 2"]) # llf is identical to that of A
llf_2_2E <- max(froc_plot_2D$data$genOrdinate[froc_plot_2D$data$Reader == "R: 2"]) # llf is identical to that of D
```

```{r froc-vs-afroc-plot2, fig.cap="Plots A and B are for 1 $\\zeta_1 = -1$ and 2 $\\zeta_1 = 2$ and plots C and D are plots for 1 $\\zeta_1 = -\\infty$ and 2 $\\zeta_1 = -\\infty$. A and C: FROC curves for the RAD-1 and RAD-2 observers. B and D: corresponding wAFROC curves.", fig.show='hold', echo=FALSE}
grid.arrange(froc_plot_2A,wafroc_plot_2B,roc_plot_2C,froc_plot_2D,wafroc_plot_2E,roc_plot_2F,nrow=2,ncol=3)
```

TBA Fig. \@ref(fig:froc-vs-afroc-plot2) (A) FROC curves for RAD-1 observer and the RAD-2 observer. The RAD-1 observer is identical to that shown in Fig. \@ref(fig:froc-vs-afroc-plot1). The RAD-2 observer is characterized by $\mu = 2$ and $\zeta_1 = 2$. This time it is impossible to compare the two FROC curves, as the common range is very small. However, wAFROC, plot B, clearly shows the expected superiority of the RAD-2 observer, in spite of the severe underestimate of the corresponding AUC.


In Fig. \@ref(fig:froc-vs-afroc-plot2) panel A, the RAD-1 parameters are the same as in Fig. \@ref(fig:froc-vs-afroc-plot1), but the RAD-2 parameters are $\mu_{2} = 2$ and $\zeta_1 = +2$. Doubling the separation parameter over that of RAD-1 ($\mu_{1} = 1$) has a huge effect on performance. The end-point coordinates of the FROC for RAD-1 are (`r nlf_1_2A`, `r llf_1_2A`). The end-point coordinates of the FROC for RAD-2 are (`r nlf_2_2A`, `r llf_2_2A`). The common NLF region defined by NLF = 0 to NLF = `r nlf_2_2A` *would exclude almost all of the marks made by RAD-1*. The wAFROC plots in panel B show the markedly greater performance of RAD-2 over RAD-1 (the AUCs are `r wafroc_1_2B` for RAD-1 and `r wafroc_2_2B` for RAD-2). The inter-reader difference is larger (compared to Fig. \@ref(fig:froc-vs-afroc-plot1) plot B), despite the greater downward bias working against the RAD-2 observer. Panel C shows ROC plots for the two observers. Although the curves cross, it is evident that RAD-2 has the greater AUC. The AUCs are `r roc_1_2C` for RAD-1 and `r roc_2_2C` for RAD-2.

Plots D, E and F correspond to A, B and C with the difference that the two threshold parameters are set to $-\infty$. The coordinates of the end-point of the RAD-1 FROC in panel D are (`r nlf_1_2D`, `r llf_1_2D`). Those of the RAD-2 FROC in panel D are (`r nlf_2_2D`, `r llf_2_2D`). The RAD-2 observer has higher LLF at lower NLF, and there can be no doubt that he is better. Panels E and F confirm that RAD-2 is actually the better observer *over the entire FPF range*. AUCs under the two wAFROC curves in E are `r wafroc_1_2E` for RAD-1 and `r wafroc_2_2E` for RAD-2. AUCs under the two ROC curves in F are `r roc_1_2F` for RAD-1 and `r roc_2_2F` for RAD-2. These confirm the visual impressions of plots in panels E and F. Notice that each ROC AUC is larger than the corresponding wAFROC AUC. 

### Small difference in performance and identical thresholds
```{r Fig3, cache = FALSE, echo=FALSE}
source(here("R/CH13-CadVsRadPlots/CadVsRadPlots.R"))

nu <- 1
lambda <- 1
K1 <- 500
K2 <- 700
muCad <- 1.0
muRad <- 1.1
zeta1Cad <- -1
zeta1Rad <- -1
Lmax <- 2
seed <- 1

ret <- do_one_figure (
  seed, Lmax, muCad, 
  muRad, lambda, nu, zeta1Cad, zeta1Rad, K1, K2)

froc_plot_3A <- ret$froc_plot_A
wafroc_plot_3B <- ret$wafroc_plot_B
roc_plot_3C <- ret$roc_plot_C
froc_plot_3D <- ret$froc_plot_D
wafroc_plot_3E <- ret$wafroc_plot_E
roc_plot_3F <- ret$roc_plot_F
wafroc_1_3B <- ret$wafroc_1_B
wafroc_2_3B <- ret$wafroc_2_B
roc_1_3C <- ret$roc_1_C
roc_2_3C <- ret$roc_2_C
wafroc_1_3E <- ret$wafroc_1_E
wafroc_2_3E <- ret$wafroc_2_E
roc_1_3F <- ret$roc_1_F
roc_2_3F <- ret$roc_2_F
```

```{r extractEndPts3, echo=FALSE}
# extract coordinates of end-point
nlf_1_3A <- max(froc_plot_3A$data$genAbscissa[froc_plot_3A$data$Reader == "R: 1"]) 
llf_1_3A <- max(froc_plot_3A$data$genOrdinate[froc_plot_3A$data$Reader == "R: 1"]) 
nlf_2_3A <- max(froc_plot_3A$data$genAbscissa[froc_plot_3A$data$Reader == "R: 2"]) 
llf_2_3A <- max(froc_plot_3A$data$genOrdinate[froc_plot_3A$data$Reader == "R: 2"]) 

nlf_1_3D <- max(froc_plot_3D$data$genAbscissa[froc_plot_3D$data$Reader == "R: 1"]) 
llf_1_3D <- max(froc_plot_3D$data$genOrdinate[froc_plot_3D$data$Reader == "R: 1"]) 
nlf_2_3D <- max(froc_plot_3D$data$genAbscissa[froc_plot_3D$data$Reader == "R: 2"]) 
llf_2_3D <- max(froc_plot_3D$data$genOrdinate[froc_plot_3D$data$Reader == "R: 2"]) 
```


```{r froc-vs-afroc-plot3, fig.cap="Plots A and B are for 1 $\\zeta_1 = -1$ and 2 $\\zeta_1 = -1$ and plots C and D are plots for 1 $\\zeta_1 = -\\infty$ and 2 $\\zeta_1 = -\\infty$. A and C: FROC curves for the RAD-1 and RAD-2 observers. B and D: corresponding wAFROC curves.", fig.show='hold', echo=FALSE}
grid.arrange(froc_plot_3A,wafroc_plot_3B,roc_plot_3C,froc_plot_3D,wafroc_plot_3E,roc_plot_3F,nrow=2,ncol=3)
```


Notice also that in all three figures the wAFROC effect size (the difference in AUCs) is larger than the corresponding ROC effect size. 

* For Fig. \@ref(fig:froc-vs-afroc-plot1), the wAFROC effect size is `r (wafroc_2_1B - wafroc_1_1B)` and the ROC effect size is `r (roc_2_1C - roc_1_1C)`. 
* For Fig. \@ref(fig:froc-vs-afroc-plot2), the wAFROC effect size is `r (wafroc_2_2B - wafroc_1_2B)` and the ROC effect size is `r (roc_2_2C - roc_1_2C)`. 
* For Fig. \@ref(fig:froc-vs-afroc-plot3), the wAFROC effect size is `r (wafroc_2_3B - wafroc_1_3B)` and the ROC effect size is `r (roc_2_3C - roc_1_3C)`. 



The final example, Fig. \@ref(fig:froc-vs-afroc-plot3) shows that *when there is a small difference in performance*, there is less ambiguity in using the FROC as a basis for measuring performance. The RAD-1 parameters are the same as in Fig. \@ref(fig:froc-vs-afroc-plot1) but the RAD-2 parameters are $\mu = 1.1$ and $\zeta_1= -1$. In other words, the $\mu$ parameter is 10% larger and the thresholds are identical. This time there is much more common NLF range overlap in plot A and one is counting most of the marks for the RAD-1 reader. The end-point coordinates of the FROC for RAD-1 are (`r nlf_1_3A`, `r llf_1_3A`). The end-point coordinates of the FROC for RAD-2 are (`r nlf_2_3A`, `r llf_2_3A`). The common NLF region defined by NLF = 0 to NLF = `r nlf_2_3A` includes almost all of the marks made by RAD-1. The wAFROC plots in panel B show the slight greater performance of RAD-2 over RAD-1 (the AUCs are `r wafroc_1_3B` for RAD-1 and `r wafroc_2_3B` for RAD-2). Panel C shows ROC plots for the two observers. Although the curves cross, it is evident that RAD-2 has the greater AUC. The AUCs are `r roc_1_2C` for RAD-1 and `r roc_2_2C` for RAD-2.

Plots D, E and F correspond to A, B and C with the difference that the two threshold parameters are set to $-\infty$. The coordinates of the end-point of the RAD-1 FROC in panel D are (`r nlf_1_3D`, `r llf_1_3D`). Those of the RAD-2 FROC in panel D are (`r nlf_2_3D`, `r llf_2_3D`). Panels E and F confirm that RAD-2 is actually the better observer over the entire FPF range. AUCs under the two wAFROC curves in E are `r wafroc_1_3E` for RAD-1 and `r wafroc_2_3E` for RAD-2. AUCs under the two ROC curves in F are `r roc_1_3F` for RAD-1 and `r roc_2_3F` for RAD-2. These confirm the visual impressions of plots in panels E and F. Notice that each ROC AUC is larger than the corresponding wAFROC AUC. 


## Summary of simulations

In order to get a better overview, the following tables summarize the numerical values from the plots in this chapter. Table \@ref(tab:froc-vs-afroc-summary-table-cad) refers to RAD-1, and Table \@ref(tab:froc-vs-afroc-summary-table-rad) refers to the RAD-2 observer.

### Summary of RAD-1 simulations

```{r cad, echo=FALSE}
dig <- 4

cell1 <- paste0("(", as.character(format(nlf_1_1A, digits = dig)), ", ", as.character(format(llf_1_1A, digits = dig)), ")")
cell2 <- paste0("(", as.character(format(nlf_1_1D, digits = dig)), ", ", as.character(format(llf_1_1D, digits = dig)), ")")
cell3 <- as.character(format(wafroc_1_1B, digits = dig))
cell4 <- as.character(format(wafroc_1_1E, digits = dig))
cell5 <- as.character(format(roc_1_1C, digits = dig))
cell6 <- as.character(format(roc_1_1F, digits = dig))
```


```{r froc-vs-afroc-summary-table-cad, echo=FALSE}
tableCells = array(dim = c(1,6))

tableCells[1, 1]  <- cell1
tableCells[1, 2]  <- cell2
tableCells[1, 3]  <- cell3
tableCells[1, 4]  <- cell4
tableCells[1, 5]  <- cell5
tableCells[1, 6]  <- cell6

df <- as.data.frame(tableCells)
colnames(df) <- c("FROC-A", "FROC-D", "wAFROC-B", "wAFROC-E", "ROC-C", "ROC-F")
knitr::kable(df, caption = "Summary of RAD-1 simulations: A refers to plot A, B refers to plot B, etc.", escape = FALSE)
```


-   The first column is labeled "FROC-A", meaning the RAD-1 FROC plots labeled A, which are identical for the three figures Fig. \@ref(fig:froc-vs-afroc-plot1), Fig. \@ref(fig:froc-vs-afroc-plot2) and Fig. \@ref(fig:froc-vs-afroc-plot3).
-   The second column is labeled "FROC-D", meaning the 1 FROC plots labeled D, which are identical for the three figures.
-   The third column is labeled "wAFROC-B", meaning the 1 wAFROC plots labeled B, which are identical for the three figures.
-   The last column is labeled "wAFROC-E", meaning the 1 wAFROC plots labeled E, which are identical for the three figures.

### Summary of RAD-2 simulations
```{r rad, echo=FALSE}

cell_11 <- "1"
cell_12 <- paste0("(", as.character(format(nlf_2_1A, digits = dig)), ", ", as.character(format(llf_2_1A, digits = dig)), ")")
cell_13 <- paste0("(", as.character(format(nlf_2_1D, digits = dig)), ", ", as.character(format(llf_2_1D, digits = dig)), ")")
cell_14 <- as.character(format(wafroc_2_1B, digits = dig))
cell_15 <- as.character(format(wafroc_2_1E, digits = dig))
cell_16 <- as.character(format(roc_2_1C, digits = dig))
cell_17 <- as.character(format(roc_2_1F, digits = dig))

cell_21 <- "2"
cell_22 <- paste0("(", as.character(format(nlf_2_2A, digits = dig)), ", ", as.character(format(llf_2_2A, digits = dig)), ")")
cell_23 <- paste0("(", as.character(format(nlf_2_2D, digits = dig)), ", ", as.character(format(llf_2_2D, digits = dig)), ")")
cell_24 <- as.character(format(wafroc_2_2B, digits = dig))
cell_25 <- as.character(format(wafroc_2_2E, digits = dig))
cell_26 <- as.character(format(roc_2_2C, digits = dig))
cell_27 <- as.character(format(roc_2_2F, digits = dig))

cell_31 <- "3"
cell_32 <- paste0("(", as.character(format(nlf_2_3A, digits = dig)), ", ", as.character(format(llf_2_3A, digits = dig)), ")")
cell_33 <- paste0("(", as.character(format(nlf_2_3D, digits = dig)), ", ", as.character(format(llf_2_3D, digits = dig)), ")")
cell_34 <- as.character(format(wafroc_2_3B, digits = dig))
cell_35 <- as.character(format(wafroc_2_3E, digits = dig))
cell_36 <- as.character(format(roc_2_3C, digits = dig))
cell_37 <- as.character(format(roc_2_3F, digits = dig))
```


```{r froc-vs-afroc-summary-table-rad, echo=FALSE}
tableCells = array(dim = c(3,7))

tableCells[1,]  <- c(cell_11, cell_12, cell_13, cell_14, cell_15, cell_16, cell_17)
tableCells[2,]  <- c(cell_21, cell_22, cell_23, cell_24, cell_25, cell_26, cell_27)
tableCells[3,]  <- c(cell_31, cell_32, cell_33, cell_34, cell_35, cell_36, cell_37)
                     
df <- as.data.frame(tableCells)
rownames(df) <- c("1","2","3")
colnames(df) <- c("Fig", "FROC-A", "FROC-D", "wAFROC-B", "wAFROC-E", "ROC-C", "ROC-F")
knitr::kable(df, caption = "Summary of RAD-2 simulations: Fig refers to the figure number in this chapter, A refers to plot A, B refers to plot B, etc.", escape = FALSE)
```

-   The first column refers to the figure number, for example, "1" refers to Fig. \@ref(fig:froc-vs-afroc-plot1), "2" refers to Fig. \@ref(fig:froc-vs-afroc-plot2), and "3" refers to Fig. \@ref(fig:froc-vs-afroc-plot3).
-   The second column is labeled "FROC-A", meaning the RAD-2 FROC plot labeled A.
-   The third column is labeled "FROC-D", meaning the RAD-2 FROC plots labeled D.
-   The fourth column is labeled "wAFROC-B", meaning the RAD-2 wAFROC plots labeled B.
-   The last column is labeled "wAFROC-E", meaning the RAD-2 wAFROC plots labeled E.



## Comments {#froc-vs-wafroc-comments}

-   For the same figure label (A, B, C or D) the 1 plots are identical in the three figures. This is the reason why Table \@ref(tab:froc-vs-afroc-summary-table-cad) has only one row.
-   A *fixed* RAD-1 dataset is being compared to *varying* RAD-2 datasets.
-   The first RAD-2 dataset, Fig. \@ref(fig:froc-vs-afroc-plot1) A or B, might be considered an average radiologist, the second one, Fig. \@ref(fig:froc-vs-afroc-plot2) A or B, is a super-expert and the third one, Fig. \@ref(fig:froc-vs-afroc-plot3) A or B, is only nominally better than RAD-1.
-   Plots C and D are for hypothetical RAD-1 and RAD-2 readers that report all suspicious regions. The differences between A and C are minimal for the RAD-1 observer, but marked for the RAD-2 observer. Likewise for the differences between B and D.

## TBA FROC gives incorrect performance ordering {#froc-vs-wafroc-froc-incorrect-ordering}
A basic principle of ROC methodology is that two points on the same operating characteristic represent the same performance.
Presented next are four plots arranged to best show the effect of a change in threshold for RAD-1 and RAD-2. The plots are related to Fig. \@ref(fig:froc-vs-afroc-plot1) and Fig. \@ref(fig:froc-vs-afroc-plot2), but they are arranged differently. The explanation follows after the figure.

```{r ZetaEffectPlots, cache = TRUE, echo=FALSE}
source(here("R/CH13-CadVsRadPlots/CadVsRadPlots.R"))

nu <- 1
lambda <- 1
K1 <- 500
K2 <- 700
muCad <- 1.0
muRad <- 2.0
zeta1Cad <- -1
zeta1Rad <- 2.0
Lmax <- 2
seed <- 1
set.seed(seed)
Lk2 <- floor(runif(K2, 1, Lmax + 1))

ret4AB <- ZetaEffectPlots (
  muCad, 
  lambda, 
  nu, 
  zeta1Cad, 
  K1, 
  K2, 
  Lk2, 
  seed,
  label = "1-")

froc_plot_4A <- ret4AB$froc$Plot + labs(tag = "A")
wafroc_plot_4B <- ret4AB$wafroc$Plot + labs(tag = "B")
wafroc_zeta1_4B <- ret4AB$wafroc1
wafroc_negInf_4B <- ret4AB$wafroc2

ret4CD <- ZetaEffectPlots (
  muRad, 
  lambda, 
  nu, 
  zeta1Rad, 
  K1, 
  K2, 
  Lk2, 
  seed,
  label = "2-")

froc_plot_4C <- ret4CD$froc$Plot + labs(tag = "C")
wafroc_plot_4D <- ret4CD$wafroc$Plot + labs(tag = "D")
wafroc_zeta1_4D <- ret4CD$fom_zeta1
wafroc_negInf_4D <- ret4CD$fom_negInf
```

```{r froc-vs-afroc-plot4, fig.cap="1/2 FROC/wAFROC plots for two values of threshold. See below.", fig.show='hold', echo=FALSE}
grid.arrange(froc_plot_4A,wafroc_plot_4B,froc_plot_4C,wafroc_plot_4D, nrow = 2, ncol = 2)
```

TBA Fig. \@ref(fig:froc-vs-afroc-plot4): Plot A is the RAD-1 FROC for two values of $\zeta_1$: the green plot is for $\zeta_1 = -1$ and the red plot, which is mostly buried under the blue plot but the short red extension is visible, is for $\zeta_1 = -\infty$. Plot B is the RAD-1 wAFROC for two values of $\zeta_1$: the green plot is for $\zeta_1 = -1$ and the red plot is for $\zeta_1 = -\infty$. Plot C is the RAD-2 FROC for two values of $\zeta_1$: the green plot is for $\zeta_1 = 2$ and the red plot, which is partially buried under the blue plot but the long red extension is visible, is for $\zeta_1 = -\infty$. Plot D is the RAD-2 wAFROC for two values of $\zeta_1$: the green plot is for $\zeta_1 = 2$ and the red plot is for $\zeta_1 = -\infty$.

In the ROC paradigm, two points on the same underlying ROC curve represent the same intrinsic performance -- all that is happening is that the observers are employing different thresholds that represent different tradeoffs between sensitivity and specificity, see the [@RN1087] study referenced in \@ref(binary-task-beam-study). If the FROC curve is to be meaningful, then two curves that differ only in thresholds must also represent identical performance.

In the following the red curve always refers to $\zeta_1 = -\infty$ while the blue curve always refers to $\zeta_1 = -1$.

1.  Plot A: The RAD-1 blue plot is completely buried (i.e., identical curves) under the RAD-1 red plot, except for a short red extension. This is because the two plots correspond to identical values of the RSM parameters $\mu, \lambda, \nu$, the only difference is in the threshold parameter $\zeta_1$: the blue corresponds to $\zeta_1 = -1$ while the red corresponds to $\zeta_1 = -\infty$. If the only difference in the curves is due to the effect of threshold, one has to conclude that the intrinsic performances of the two observers, i.e., 1 with different thresholds, are in fact identical. In fact this is an incorrect conclusion, see below, which argues against the notion that the FROC curve is meaningful.
2.  Plot B: this time the RAD-1 curve extends all the way from (0,0) to (1,1) and so does the RAD-2 curve (most of which is buried under the blue one). A relatively small performance difference is evident: the blue curve has higher wAFROC-AUC = `r wafroc_1_2B`, than the red one, wAFROC-AUC = `r wafroc_1_2E`. The reason for this can be understood by noting that with the chosen $\mu = 1$ threshold $\zeta_1 = -1$ one is starting out on the relatively flat portion of the FROC. Upon extending it to higher NLF by lowering the threshold to $\zeta_1 = -\infty$, the increase in the LLF is modest, but NLF has increased substantially. Since relatively few additional lesions are being localized but the penalty is more NLs, intrinsic performance for the red curve is expected to decrease. The difference in performance is `r (wafroc_1_2B - wafroc_1_2E)`. *The wAFROC gives the correct ordering of the two observers, one that is missed by the FROC.* The argument is more convincing upon comparing the observers' in Fig. \@ref(fig:froc-vs-afroc-plot4) C and D.
3.  Plot C: the RAD-2 FROC plot is partially buried under the RAD-1 plot, a short near vertical segment from (0,0) to (`r nlf_2_2A`, `r llf_2_2A`), in the region near the origin. Thereafter the RAD-2 FROC plot resumes a sweeping curve all the way to (`r nlf_2_2D`, `r llf_2_2D`). Since the two curves are identical except for changing thresholds, one must conclude based on the FROC, that the two performances are identical.
4.  Plot D: the RAD-2 blue curve extends all the way from (0,0) to (1,1) and so does the RAD-2 red curve (a short portion of which, near the origin, is buried under the blue one). A large performance difference is evident: the red curve has higher wAFROC-AUC = `r wafroc_2_2E`, than the blue one, wAFROC-AUC = `r wafroc_2_2B`. The explanation for this is that with the chosen 2 parameters -- $\mu = 2$ and initial threshold $\zeta_1 = 2$ -- one is starting on the relatively steep portion of the FROC and extending it to both higher LLF and higher NLF. Since many additional lesions are being localized, and one is counting only the highest rated NL on each non-diseased case, the penalty of more NLs is more than outweighed by the increased number of lesions localized. The difference in performance is `r (wafroc_2_2E - wafroc_2_2B)`. Again, the wAFROC gives the correct ordering of the two observers, one that is missed by the FROC.

The essential reason why the wAFROC gives the correct ordering but the FROC does not is that the wAFROC, being contained in the unit square, gives the complete picture. The FROC, not so constrained to the unit square, does not. 

Note that the direction of the threshold-change effect depends on the starting point on the FROC: if one starts on the relatively flat portion of the FROC, then lowering the threshold all the way to $-\infty$ decreases performance; if one starts on the relatively steep portion, then lowering the threshold all the way to $-\infty$ increases performance. An intermediate starting point can be found where there is no threshold-change effect.

The argument depends critically on the area under the straight line extension from the end-point to (1,1) being included in the wAFROC-AUC. If this were not allowed one could argue that the end-point of the blue curve (`r fpfRad2B`, `r llf_2_2B`) -- quite visible as the sharp inflection in plot D -- lies on the same wAFROC curve as the end-point of the red curve (`r fpfRad2E`, `r llf_2_2D`) -- not so readily visible. The justification for the straight line extension is deferred to Chapter \@ref(froc-meanings).

```{r do_one_mu,cache=TRUE, echo=FALSE}
do_one_mu <- function(zeta1Arr, fomArray, mu, lambda, nu, K1, K2, Lk2, seed) {
  
  for (i in 1:length(zeta1Arr)) {
    froc1 <- SimulateFrocDataset (
      mu = mu,
      lambda = lambda,
      nu = nu,
      zeta1 = zeta1Arr[i],
      I = 1,
      J = 1,
      K1 = K1,
      K2 = K2,
      perCase = Lk2,
      seed = seed)
    
    froc1$descriptions$readerID <- "1"
    fomArray[i] <- as.numeric(UtilFigureOfMerit(froc1, FOM = "wAFROC"))
    #cat("zeta1 = ", zeta1Arr[i], "fom = ", as.numeric(fomArray[i]), "\n")
  }
  #cat("\n")
  myData <- data.frame(zeta1Arr = zeta1Arr, fomArray = fomArray)
  p <- ggplot2::ggplot(myData, aes(x = zeta1Arr, y = fomArray)) + geom_line()
  zetaMax <- zeta1Arr[which.max(fomArray)]
  return(list(
    p = p,
    zetaMax = zetaMax
  ))
}
```


## Finding optimal operating point on the FROC

**Optimal operating point for 2**

```{r optOperatingPointRad, cache = TRUE, echo=FALSE}

lambda <- nu <- 1
mu_arr <- c(1, 1.5, 2, 2.5)
max_fomArray <- nlfArr <- zetaMaxArr <- array(dim = length(mu_arr))
plotArr <- array(list(), length(mu_arr))
K1 <- 500
K2 <- 700
Lmax <- 2
seed <- 1
set.seed(seed)
Lk2 <- floor(runif(K2, 1, Lmax + 1))

for (i in 1:length(mu_arr)) {
  zeta1Arr <- seq(-1,1,0.1)
  fomArray <- array(dim = length(zeta1Arr))
  x <- do_one_mu (zeta1Arr, fomArray, mu_arr[i], lambda, nu, K1, K2, Lk2, seed)
  plotArr[[i]] <- x$p + ggtitle(paste0("mu = ", as.character(mu_arr[i]), ", zetaMax = ",  as.character(x$zetaMax)))
  zetaMaxArr[i] <- x$zetaMax
  froc1 <- SimulateFrocDataset (
    mu = mu_arr[i],
    lambda = lambda,
    nu = nu,
    zeta1 = x$zetaMax,
    I = 1,
    J = 1,
    K1 = K1,
    K2 = K2,
    perCase = Lk2,
    seed = seed)
  max_fomArray[i] <- as.numeric(UtilFigureOfMerit(froc1, FOM = "wAFROC"))
  phys <- UtilIntrinsic2PhysicalRSM(mu_arr[i], lambda, nu)
  nlfArr[i] <- phys$lambdaP*pnorm(-zetaMaxArr[i])
}
```

```{r printRAD, echo=FALSE}
print(as.data.frame(mu_arr))
print(as.data.frame(zetaMaxArr))
print(as.data.frame(max_fomArray))
print(as.data.frame(nlfArr))
```

```{r froc-vs-afroc-plot5, fig.cap="TBA. See below.", fig.show='hold', echo=FALSE}
grid.arrange(plotArr[[1]],plotArr[[2]],plotArr[[3]],plotArr[[4]], nrow = 2, ncol = 2)
```

**Optimal operating point for 1**
```{r optOperatingPointCad, cache = TRUE, echo=FALSE}

lambda <- 10
mu_arr <- c(1, 1.5, 2, 2.5)
max_fomArray <- nlfArr <- zetaMaxArr <- array(dim = length(mu_arr))
plotArr <- array(list(), length(mu_arr))
K1 <- 500
K2 <- 700
Lmax <- 2
seed <- 1
set.seed(seed)
Lk2 <- floor(runif(K2, 1, Lmax + 1))

for (i in 1:length(mu_arr)) {
  zeta1Arr <- seq(-1,2,0.1)
  fomArray <- array(dim = length(zeta1Arr))
  x <- do_one_mu (zeta1Arr, fomArray, mu_arr[i], lambda, nu, K1, K2, Lk2, seed)
  plotArr[[i]] <- x$p + ggtitle(paste0("mu = ", as.character(mu_arr[i]), ", zetaMax = ",  as.character(x$zetaMax)))
  zetaMaxArr[i] <- x$zetaMax
  froc1 <- SimulateFrocDataset (
    mu = mu_arr[i],
    lambda = lambda,
    nu = nu,
    zeta1 = x$zetaMax,
    I = 1,
    J = 1,
    K1 = K1,
    K2 = K2,
    perCase = Lk2,
    seed = seed)
  max_fomArray[i] <- as.numeric(UtilFigureOfMerit(froc1, FOM = "wAFROC"))
  phys <- UtilIntrinsic2PhysicalRSM(mu_arr[i], lambda, nu)
  nlfArr[i] <- phys$lambdaP*pnorm(-zetaMaxArr[i])
}
```

```{r printCAD}
print(as.data.frame(mu_arr))
print(as.data.frame(zetaMaxArr))
print(as.data.frame(max_fomArray))
print(as.data.frame(nlfArr))
```

```{r froc-vs-afroc-plot6, fig.cap="TBA. See below.", fig.show='hold', echo=FALSE}
grid.arrange(plotArr[[1]],plotArr[[2]],plotArr[[3]],plotArr[[4]], nrow = 2, ncol = 2)
```

## Discussion {#froc-vs-wafroc-Discussion}

## References {#froc-vs-wafroc-references}
